<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="batch_report" language="groovy" pageWidth="612" pageHeight="792" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="bdb39679-e78c-42c2-af38-8bee4229daa4">
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="job_id" class="java.lang.Integer"/>
	<parameter name="sort_column" class="java.lang.String">
		<defaultValueExpression><![CDATA["product_name"]]></defaultValueExpression>
	</parameter>
	<parameter name="sort_direction" class="java.lang.String">
		<defaultValueExpression><![CDATA["ASC"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[WITH business AS (
			SELECT business_name, street_address, city, state, zip_code, phone
			FROM business_info
			LIMIT 1
		),
		job_info AS (
			SELECT id, job_name, job_date, gpa_rate, tank_size
			FROM jobs
			WHERE id = $P{job_id}
		),
		job_fields_list AS (
			SELECT 
				jf.job_id,
				STRING_AGG(DISTINCT f.field_number, ', ' ORDER BY f.field_number) as field_numbers
			FROM job_fields jf
			JOIN fields f ON jf.field_id = f.id
			WHERE jf.job_id = $P{job_id}
			GROUP BY jf.job_id
		),
		job_batches_list AS (
			SELECT 
				id as batch_id,
				batch_number,
				gallons,
				acres
			FROM job_batches
			WHERE job_id = $P{job_id}
			ORDER BY batch_number
		),
		batch_products AS (
			SELECT 
				jb.id as batch_id, 
				jb.batch_number, 
				jb.gallons, 
				jb.acres,
				p.id as product_id,
				p.name as product_name,
				COALESCE(jbp.amount, 0) as product_amount,
				COALESCE(jbp.gallons, 0) as product_gallons,
				COALESCE(jp.rate, 0) as product_rate,
				COALESCE(jp.rate_unit, '') || CASE WHEN jp.rate_basis='100gal' THEN '/100 gal' ELSE '/ac' END as product_unit,
				COALESCE(p.epa_reg_no, '') as epa_reg_no,
				COALESCE(jbp.gallons, 0) as product_volume_gal
			FROM job_batches jb
			JOIN job_batch_products jbp ON jb.id = jbp.job_batch_id
			JOIN job_products jp ON jbp.job_product_id = jp.id
			JOIN products p ON jp.product_id = p.id
			WHERE jb.job_id = $P{job_id}
		),
		batch_calcs AS (
			SELECT
				jbl.batch_id,
				jbl.batch_number,
				jbl.gallons,
				jbl.acres,
				COALESCE(SUM(bp.product_volume_gal), 0) as product_total_gal
			FROM job_batches_list jbl
			LEFT JOIN batch_products bp ON jbl.batch_id = bp.batch_id
			GROUP BY jbl.batch_id, jbl.batch_number, jbl.gallons, jbl.acres
		)
		SELECT
			b.business_name,
			b.street_address,
			b.city,
			b.state,
			b.zip_code,
			b.phone,
			j.job_name,
			j.job_date,
			j.gpa_rate,
			j.tank_size,
			bc.batch_id,
			bc.batch_number,
			bc.gallons as batch_gallons,
			bc.acres as batch_acres,
			bc.product_total_gal,
			COALESCE(GREATEST(0, bc.gallons - bc.product_total_gal), 0) as water_gallons,
			bp.product_id,
			bp.product_name,
			bp.product_gallons,
			bp.product_amount,
			bp.product_rate,
			bp.product_unit,
			bp.epa_reg_no,
			jfl.field_numbers
		FROM business b
		CROSS JOIN job_info j
		JOIN batch_calcs bc ON 1=1
		LEFT JOIN batch_products bp ON bc.batch_id = bp.batch_id
		LEFT JOIN job_fields_list jfl ON jfl.job_id = j.id
		ORDER BY bc.batch_number,
		CASE 
			WHEN $P{sort_column} = 'product_amount' AND $P{sort_direction} = 'ASC' THEN bp.product_amount
			WHEN $P{sort_column} = 'product_amount' AND $P{sort_direction} = 'DESC' THEN -bp.product_amount
			WHEN $P{sort_column} = 'product_gallons' AND $P{sort_direction} = 'ASC' THEN bp.product_gallons
			WHEN $P{sort_column} = 'product_gallons' AND $P{sort_direction} = 'DESC' THEN -bp.product_gallons
			ELSE 0
		END,
		CASE 
			WHEN $P{sort_column} = 'product_unit' AND $P{sort_direction} = 'ASC' THEN bp.product_unit
			WHEN $P{sort_column} = 'epa_reg_no' AND $P{sort_direction} = 'ASC' THEN bp.epa_reg_no
			WHEN $P{sort_direction} = 'ASC' THEN bp.product_name
			ELSE ''
		END,
		CASE 
			WHEN $P{sort_column} = 'product_unit' AND $P{sort_direction} = 'DESC' THEN bp.product_unit
			WHEN $P{sort_column} = 'epa_reg_no' AND $P{sort_direction} = 'DESC' THEN bp.epa_reg_no
			WHEN $P{sort_column} = 'product_name' AND $P{sort_direction} = 'DESC' THEN bp.product_name
			WHEN $P{sort_direction} = 'DESC' THEN bp.product_name
			ELSE ''
		END DESC,
		CASE 
			WHEN $P{sort_column} = 'product_name' AND $P{sort_direction} = 'DESC' THEN ''
			ELSE bp.product_name
		END ASC]]>
	</queryString>
	<field name="business_name" class="java.lang.String"/>
	<field name="street_address" class="java.lang.String"/>
	<field name="city" class="java.lang.String"/>
	<field name="state" class="java.lang.String"/>
	<field name="zip_code" class="java.lang.String"/>
	<field name="phone" class="java.lang.String"/>
	<field name="job_name" class="java.lang.String"/>
	<field name="job_date" class="java.util.Date"/>
	<field name="gpa_rate" class="java.math.BigDecimal"/>
	<field name="tank_size" class="java.math.BigDecimal"/>
	<field name="batch_id" class="java.lang.Integer"/>
	<field name="batch_number" class="java.lang.Integer"/>
	<field name="batch_gallons" class="java.math.BigDecimal"/>
	<field name="batch_acres" class="java.math.BigDecimal"/>
	<field name="product_total_gal" class="java.math.BigDecimal"/>
	<field name="water_gallons" class="java.math.BigDecimal"/>
	<field name="product_id" class="java.lang.Integer"/>
	<field name="product_name" class="java.lang.String"/>
	<field name="product_gallons" class="java.math.BigDecimal"/>
	<field name="product_amount" class="java.math.BigDecimal"/>
	<field name="product_unit" class="java.lang.String"/>
	<field name="epa_reg_no" class="java.lang.String"/>
	<field name="field_numbers" class="java.lang.String"/>
	<field name="product_rate" class="java.math.BigDecimal"/>
	
	<variable name="productCount" class="java.lang.Integer" resetType="Group" resetGroup="BatchGroup" calculation="Count">
		<variableExpression><![CDATA[$F{product_name}]]></variableExpression>
		<initialValueExpression><![CDATA[0]]></initialValueExpression>
	</variable>
	
	<variable name="hasProducts" class="java.lang.Boolean" resetType="Group" resetGroup="BatchGroup">
		<variableExpression><![CDATA[Boolean.valueOf($F{product_name} != null)]]></variableExpression>
		<initialValueExpression><![CDATA[Boolean.FALSE]]></initialValueExpression>
	</variable>
	
	<group name="BatchGroup" keepTogether="true">
		<groupExpression><![CDATA[$F{batch_number}]]></groupExpression>
		<groupHeader>
			<band height="65" splitType="Prevent">
				<!-- Batch Title -->
				<textField>
					<reportElement x="5" y="5" width="545" height="25" forecolor="#3465a4" uuid="550e8400-e29b-41d4-a716-446655440020"/>
					<textElement>
						<font size="14" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA["Batch " + $F{batch_number} + " - Field " + ($F{field_numbers} == null ? "" : $F{field_numbers}) + " - " + new DecimalFormat("#,##0.00").format($F{batch_acres}) + " acres"]]></textFieldExpression>
				</textField>
				
				<!-- Column Headers -->
				<rectangle>
					<reportElement x="0" y="35" width="555" height="25" backcolor="#E0E0E0" uuid="550e8400-e29b-41d4-a716-446655440018"/>
				</rectangle>
				<staticText>
					<reportElement x="5" y="38" width="165" height="20" uuid="550e8400-e29b-41d4-a716-446655440019"/>
					<textElement verticalAlignment="Middle">
						<font size="10" isBold="true"/>
					</textElement>
					<text><![CDATA[Product Name]]></text>
				</staticText>
				<staticText>
					<reportElement x="170" y="38" width="80" height="20" uuid="550e8400-e29b-41d4-a716-446655440021"/>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font size="10" isBold="true"/>
					</textElement>
					<text><![CDATA[Amount]]></text>
				</staticText>
				<staticText>
					<reportElement x="245" y="38" width="70" height="20" uuid="550e8400-e29b-41d4-a716-446655440100"/>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font size="10" isBold="true"/>
					</textElement>
					<text><![CDATA[Rate /ac]]></text>
				</staticText>
				<staticText>
					<reportElement x="320" y="38" width="50" height="20" uuid="550e8400-e29b-41d4-a716-446655440101"/>
					<textElement textAlignment="Center" verticalAlignment="Middle">
						<font size="10" isBold="true"/>
					</textElement>
					<text><![CDATA[Unit]]></text>
				</staticText>
				<staticText>
					<reportElement x="370" y="38" width="70" height="20" uuid="550e8400-e29b-41d4-a716-446655440102"/>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font size="10" isBold="true"/>
					</textElement>
					<text><![CDATA[Gallons]]></text>
				</staticText>
				<staticText>
					<reportElement x="450" y="38" width="105" height="20" uuid="550e8400-e29b-41d4-a716-446655440103"/>
					<textElement verticalAlignment="Middle">
						<font size="10" isBold="true"/>
					</textElement>
					<text><![CDATA[EPA REG #]]></text>
				</staticText>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="85" splitType="Prevent">
				<staticText>
					<reportElement x="30" y="5" width="140" height="15" uuid="550e8400-e29b-41d4-a716-446655440025"/>
					<textElement textAlignment="Right">
						<font size="11" isBold="true"/>
					</textElement>
					<text><![CDATA[Product Total (gal):]]></text>
				</staticText>
				<textField pattern="#,##0.00" isBlankWhenNull="true">
					<reportElement x="170" y="5" width="80" height="15" uuid="550e8400-e29b-41d4-a716-446655440026"/>
					<textElement textAlignment="Right">
						<font size="11"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{product_total_gal}]]></textFieldExpression>
				</textField>
				
				<staticText>
					<reportElement x="30" y="20" width="140" height="15" uuid="550e8400-e29b-41d4-a716-446655440027"/>
					<textElement textAlignment="Right">
						<font size="11" isBold="true"/>
					</textElement>
					<text><![CDATA[Water (gal):]]></text>
				</staticText>
				<textField pattern="#,##0.00" isBlankWhenNull="true">
					<reportElement x="170" y="20" width="80" height="15" uuid="550e8400-e29b-41d4-a716-446655440028"/>
					<textElement textAlignment="Right">
						<font size="11"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{water_gallons}]]></textFieldExpression>
				</textField>
				
				<staticText>
					<reportElement x="30" y="35" width="140" height="15" uuid="550e8400-e29b-41d4-a716-446655440029"/>
					<textElement textAlignment="Right">
						<font size="11" isBold="true"/>
					</textElement>
					<text><![CDATA[Total Batch (gal):]]></text>
				</staticText>
				<textField pattern="#,##0.00" isBlankWhenNull="true">
					<reportElement x="170" y="35" width="80" height="15" uuid="550e8400-e29b-41d4-a716-446655440030"/>
					<textElement textAlignment="Right">
						<font size="11"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{batch_gallons}]]></textFieldExpression>
				</textField>
				
				<staticText>
					<reportElement x="30" y="50" width="140" height="15" uuid="550e8400-e29b-41d4-a716-446655440031"/>
					<textElement textAlignment="Right">
						<font size="11" isBold="true"/>
					</textElement>
					<text><![CDATA[Total Batch Acres:]]></text>
				</staticText>
				<textField pattern="#,##0.00" isBlankWhenNull="true">
					<reportElement x="170" y="50" width="80" height="15" uuid="550e8400-e29b-41d4-a716-446655440032"/>
					<textElement textAlignment="Right">
						<font size="11"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{batch_acres}]]></textFieldExpression>
				</textField>
				
				<line>
					<reportElement x="0" y="75" width="555" height="1" forecolor="#CCCCCC" uuid="550e8400-e29b-41d4-a716-446655440033"/>
				</line>
			</band>
		</groupFooter>
	</group>
	
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="160" splitType="Stretch">
			<staticText>
				<reportElement x="380" y="6" width="220" height="52" forecolor="#E6E6E6" uuid="550e8400-e29b-41d4-a716-446655440000"/>
				<box>
					<pen lineColor="#FFFFFF"/>
					<topPen lineColor="#FFFFFF"/>
					<leftPen lineColor="#FFFFFF"/>
					<bottomPen lineColor="#FFFFFF"/>
					<rightPen lineColor="#FFFFFF"/>
				</box>
				<textElement>
					<font size="28" isBold="true"/>
				</textElement>
				<text><![CDATA[Batch Report]]></text>
			</staticText>
			<staticText>
				<reportElement x="461" y="58" width="40" height="15" uuid="550e8400-e29b-41d4-a716-446655440001"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Date:]]></text>
			</staticText>
			<textField pattern="MM/dd/yyyy">
				<reportElement x="501" y="58" width="64" height="15" uuid="550e8400-e29b-41d4-a716-446655440002"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="461" y="73" width="40" height="15" uuid="550e8400-e29b-41d4-a716-446655440003"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Time:]]></text>
			</staticText>
			<textField pattern="HH:mm:ss">
				<reportElement x="501" y="73" width="64" height="15" uuid="550e8400-e29b-41d4-a716-446655440004"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="19" width="400" height="26" uuid="550e8400-e29b-41d4-a716-446655440005"/>
				<textElement>
					<font size="18" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{business_name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="45" width="400" height="15" uuid="550e8400-e29b-41d4-a716-446655440006"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{street_address}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="60" width="400" height="15" uuid="550e8400-e29b-41d4-a716-446655440007"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{city} + ", " + $F{state} + " " + $F{zip_code}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="75" width="400" height="15" uuid="550e8400-e29b-41d4-a716-446655440008"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{phone}]]></textFieldExpression>
			</textField>
			
			<staticText>
				<reportElement x="5" y="100" width="70" height="15" uuid="550e8400-e29b-41d4-a716-446655440009"/>
				<textElement>
					<font size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Job Name:]]></text>
			</staticText>
			<textField>
				<reportElement x="77" y="100" width="180" height="15" uuid="550e8400-e29b-41d4-a716-446655440010"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{job_name}]]></textFieldExpression>
			</textField>
			
			<staticText>
				<reportElement x="5" y="115" width="50" height="15" uuid="550e8400-e29b-41d4-a716-446655440011"/>
				<textElement>
					<font size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Date:]]></text>
			</staticText>
			<textField pattern="MM/dd/yyyy">
				<reportElement x="57" y="115" width="75" height="15" uuid="550e8400-e29b-41d4-a716-446655440012"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{job_date}]]></textFieldExpression>
			</textField>
			
			<staticText>
				<reportElement x="140" y="115" width="65" height="15" uuid="550e8400-e29b-41d4-a716-446655440013"/>
				<textElement>
					<font size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[GPA/Rate:]]></text>
			</staticText>
			<textField pattern="#,##0.00">
				<reportElement x="208" y="115" width="50" height="15" uuid="550e8400-e29b-41d4-a716-446655440014"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{gpa_rate}]]></textFieldExpression>
			</textField>
			
			<staticText>
				<reportElement x="270" y="115" width="65" height="15" uuid="550e8400-e29b-41d4-a716-446655440015"/>
				<textElement>
					<font size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Tank Size:]]></text>
			</staticText>
			<textField pattern="#,##0.00">
				<reportElement x="338" y="115" width="50" height="15" uuid="550e8400-e29b-41d4-a716-446655440016"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{tank_size}]]></textFieldExpression>
			</textField>
			
			<line>
				<reportElement x="0" y="150" width="555" height="1" forecolor="#CCCCCC" uuid="550e8400-e29b-41d4-a716-446655440038"/>
			</line>
		</band>
	</title>
	<pageHeader>
		<band height="40" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="5" width="555" height="30" uuid="550e8400-e29b-41d4-a716-446655440017"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="16" isBold="true"/>
				</textElement>
				<text><![CDATA[Batch Details]]></text>
			</staticText>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="0" splitType="Stretch"/>
	</columnHeader>
	<detail>
		<band height="20" splitType="Stretch">
			<printWhenExpression><![CDATA[$F{product_name} != null]]></printWhenExpression>
			<rectangle>
				<reportElement x="0" y="0" width="555" height="20" backcolor="#FFFFFF" uuid="550e8400-e29b-41d4-a716-446655440041">
					<printWhenExpression><![CDATA[new Boolean($V{REPORT_COUNT} % 2 == 0)]]></printWhenExpression>
				</reportElement>
				<graphicElement>
					<pen lineWidth="0.0"/>
				</graphicElement>
			</rectangle>
			<rectangle>
				<reportElement x="0" y="0" width="555" height="20" backcolor="#F8F8F8" uuid="550e8400-e29b-41d4-a716-446655440042">
					<printWhenExpression><![CDATA[new Boolean($V{REPORT_COUNT} % 2 != 0)]]></printWhenExpression>
				</reportElement>
				<graphicElement>
					<pen lineWidth="0.0"/>
				</graphicElement>
			</rectangle>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement x="5" y="0" width="165" height="20" uuid="550e8400-e29b-41d4-a716-446655440023"/>
				<textElement verticalAlignment="Middle">
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{product_name}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00" isBlankWhenNull="true">
				<reportElement x="170" y="0" width="80" height="20" uuid="550e8400-e29b-41d4-a716-446655440024"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{product_amount}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00" isBlankWhenNull="true">
				<reportElement x="245" y="0" width="70" height="20" uuid="550e8400-e29b-41d4-a716-446655440104"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{product_rate}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="320" y="0" width="50" height="20" uuid="550e8400-e29b-41d4-a716-446655440105"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{product_unit}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00" isBlankWhenNull="true">
				<reportElement x="370" y="0" width="70" height="20" uuid="550e8400-e29b-41d4-a716-446655440106"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{product_gallons} != null && $F{product_gallons} > 0 ? $F{product_gallons} : ""]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="450" y="0" width="105" height="20" uuid="550e8400-e29b-41d4-a716-446655440107"/>
				<textElement verticalAlignment="Middle">
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{epa_reg_no}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band height="0" splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band height="25" splitType="Stretch">
			<textField>
				<reportElement x="455" y="0" width="70" height="25" uuid="550e8400-e29b-41d4-a716-446655440034"/>
				<textElement textAlignment="Right">
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA["Page " + $V{PAGE_NUMBER} + " of "]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report">
				<reportElement x="525" y="0" width="30" height="25" uuid="550e8400-e29b-41d4-a716-446655440035"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField pattern="MM/dd/yyyy">
				<reportElement x="5" y="0" width="100" height="25" uuid="550e8400-e29b-41d4-a716-446655440036"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
</jasperReport>
