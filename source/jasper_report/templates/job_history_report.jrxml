<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="job_history_report" language="groovy" pageWidth="612" pageHeight="792" whenNoDataType="AllSectionsNoDetail" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="4bddcaca-5776-43f2-b986-958cb4c5692f">
	<property name="ireport.zoom" value="1.2100000000000006"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="start_date" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date()]]></defaultValueExpression>
	</parameter>
	<parameter name="end_date" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date()]]></defaultValueExpression>
	</parameter>
	<parameter name="search_term" class="java.lang.String">
		<defaultValueExpression><![CDATA[""]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[WITH business AS (
			SELECT business_name, street_address, city, state, zip_code, phone
			FROM business_info
			LIMIT 1
		),
		job_details AS (
			SELECT
				j.id,
				j.job_name,
				j.job_date,
				COALESCE(STRING_AGG(DISTINCT f.name, ', ' ORDER BY f.name), 'No fields') as fields_applied
			FROM jobs j
			LEFT JOIN job_fields jf ON j.id = jf.job_id
			LEFT JOIN fields f ON jf.field_id = f.id
			WHERE j.job_date BETWEEN $P{start_date} AND $P{end_date}
			AND (
				$P{search_term} = '' OR
				j.job_name ILIKE '%' || $P{search_term} || '%' OR
				EXISTS (
					SELECT 1 FROM job_batches jb
					WHERE jb.job_id = j.id AND CAST(jb.batch_number AS TEXT) ILIKE '%' || $P{search_term} || '%'
				) OR
				EXISTS (
					SELECT 1 FROM job_products jp
					JOIN products p ON jp.product_id = p.id
					WHERE jp.job_id = j.id AND p.name ILIKE '%' || $P{search_term} || '%'
				)
			)
			GROUP BY j.id, j.job_name, j.job_date
			ORDER BY j.job_date DESC
		)
		SELECT
			b.business_name,
			b.street_address,
			b.city,
			b.state,
			b.zip_code,
			b.phone,
			CAST(jd.id AS VARCHAR) as job_number,
			jd.job_name,
			jd.fields_applied,
			to_char(jd.job_date, 'MM/DD/YYYY') as date_created
		FROM business b
		CROSS JOIN job_details jd]]>
	</queryString>
	<field name="business_name" class="java.lang.String"/>
	<field name="street_address" class="java.lang.String"/>
	<field name="city" class="java.lang.String"/>
	<field name="state" class="java.lang.String"/>
	<field name="zip_code" class="java.lang.String"/>
	<field name="phone" class="java.lang.String"/>
	<field name="job_number" class="java.lang.String"/>
	<field name="job_name" class="java.lang.String"/>
	<field name="fields_applied" class="java.lang.String"/>
	<field name="date_created" class="java.lang.String"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="96" splitType="Stretch">
			<staticText>
				<reportElement x="450" y="6" width="110" height="52" forecolor="#E6E6E6" uuid="016e0913-fdcb-4227-bf9e-3327a6fc9c69"/>
				<box>
					<pen lineColor="#FFFFFF"/>
					<topPen lineColor="#FFFFFF"/>
					<leftPen lineColor="#FFFFFF"/>
					<bottomPen lineColor="#FFFFFF"/>
					<rightPen lineColor="#FFFFFF"/>
				</box>
				<textElement>
					<font size="28" isBold="true"/>
				</textElement>
				<text><![CDATA[Report]]></text>
			</staticText>
			<staticText>
				<reportElement x="461" y="58" width="40" height="15" uuid="017e0914-fdcb-4227-bf9e-3327a6fc9c70"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Date:]]></text>
			</staticText>
			<textField pattern="MM/dd/yyyy">
				<reportElement x="501" y="58" width="64" height="15" uuid="018e0915-fdcb-4227-bf9e-3327a6fc9c71"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="461" y="73" width="40" height="15" uuid="019e0916-fdcb-4227-bf9e-3327a6fc9c72"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Time:]]></text>
			</staticText>
			<textField pattern="HH:mm:ss">
				<reportElement x="501" y="73" width="64" height="15" uuid="020e0917-fdcb-4227-bf9e-3327a6fc9c73"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="19" width="400" height="26" uuid="0cf9bcd7-c7a1-4af6-b489-9cc8eac3fd9e"/>
				<textElement>
					<font size="18" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{business_name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="45" width="400" height="15" uuid="06791330-a087-4258-9431-9fab9d340a64"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{street_address}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="60" width="400" height="15" uuid="1af2ea39-6151-4995-abe9-a020be4c5aaf"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{city} + ", " + $F{state} + " " + $F{zip_code}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="5" y="75" width="400" height="15" uuid="ad6f295d-457c-4373-bc23-330fe8a5bdeb"/>
				<textElement>
					<font size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{phone}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band height="27" splitType="Stretch">
			<textField>
				<reportElement x="5" y="5" width="180" height="20" uuid="a1b2c3d4-e5f6-4a5b-8c7d-9e8f7a6b5c4d"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA["Start Date: " + $P{start_date}.format('MM/dd/yyyy')]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="190" y="5" width="180" height="20" uuid="b2c3d4e5-f6a7-5b6c-9d8e-0f1a2b3c4d5e"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA["End Date: " + $P{end_date}.format('MM/dd/yyyy')]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="375" y="5" width="180" height="20" uuid="c3d4e5f6-a7b8-6c7d-0e1f-2a3b4c5d6e7f"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA["Search Term: " + ($P{search_term} == "" ? "None" : $P{search_term})]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="20" splitType="Stretch">
			<rectangle>
				<reportElement x="0" y="0" width="555" height="20" backcolor="#99CCFF" uuid="49a0b3ef-5731-4d9b-bd78-d2fc4f5747dc"/>
			</rectangle>
			<staticText>
				<reportElement x="5" y="0" width="180" height="20" uuid="72d9d6f0-60d4-431d-aa42-c0fe75b9e44c"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Job Name]]></text>
			</staticText>
			<staticText>
				<reportElement x="190" y="0" width="250" height="20" uuid="f1f2f3f4-f5f6-f7f8-f9f0-fabcdef01234"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Fields]]></text>
			</staticText>
			<staticText>
				<reportElement x="445" y="0" width="100" height="20" uuid="c5682a9c-cc69-4caa-a89a-2a9b5d48f60f"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Date Created]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="20" splitType="Stretch">
			<textField>
				<reportElement x="5" y="5" width="180" height="14" uuid="72d9d6f0-60d4-431d-aa42-c0fe75b9e44d"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{job_name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="190" y="5" width="250" height="14" uuid="e1e2e3e4-e5e6-e7e8-e9f0-eabcdef01235"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{fields_applied}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="445" y="5" width="100" height="14" uuid="c5682a9c-cc69-4caa-a89a-2a9b5d48f610"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{date_created}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band height="45" splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band height="54" splitType="Stretch"/>
	</pageFooter>
	<summary>
		<band height="42" splitType="Stretch"/>
	</summary>
</jasperReport>
